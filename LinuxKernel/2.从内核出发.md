# 2. 从内核出发 

**Author:** *ciichen*  
**Email:** [*ciichen235@gmail.com*](mailto:陈林<ciichen235@gmail.com>)  
**Time:** *2021/9/23*  

- [2. 从内核出发](#2-从内核出发)
  - [内核开发的特点](#内核开发的特点)

---

## 内核开发的特点  

* 内核编程时，既不能访问 C 库，也不能访问标准的 C 头文件。  
  C 库不能链接标准 C 库函数主要原因是速度和大小。大部分常用的 C 库函数都在内核  
  中已经实现了，位于 `include/linux/string.h` 这个目录下面。使用时，直接包含  
  `<linux/string.h>` 即可。  
* 内核编程时必须使用 GNU C 。  
  GNU C 中包含 C 语言的扩展。内核中常见的包括分支声明：  
  ```c
  // 认为 error 条件绝大多数情况不会发生
  if (unlikely(error)) {
      /* ... */
  }
  // 认为 success 通常不是 0
  if (likely(success)) {
      /* ... */
  }
  ```
  编译器会为条件语句优化，避免 `likely` 的语句在执行过程中发生跳转。  
* 内核编程是缺乏像用户空间的内存保护机制。  
* 内核编程时，难以执行浮点运算。  
  在内核中使用浮点数，要人工保存和恢复浮点数寄存器，最好不要使用浮点数寄存器。  
* 内核给每个进程（内核进程）只有一个很小的定长堆栈。  
* 必须时刻注意并发与同步。  
  常见的解决竞争的办法是使用自旋锁和信号量。  
  * Linux 是抢占多任务操作系统。  
  * Linux 内核支持对称多处理器（SMP）。  
  * Linux 内核可以抢占。  
* 考虑可移植性。比如，保持字节序、64 位对齐、不假定字长和页面长度。    